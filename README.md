# Is

Функционал ролей для фреймворка Laravel.

## Содержание

1. [Подключение](#подключение)

    - [Публикация ресурсов](#публикация-ресурсов)

2. [Перед использованием](#перед-использованием)

    - [Миграции](#миграции)
    - [Сидеры](#сидеры)
    - [Добавление функционала ролей модели](#добавление-функционала-ролей-модели)
    - [Иерархия ролей](#иерархия-ролей)

3. [Использование](#использование)

    - [Прикрепление роли](#прикрепление-роли)
    - [Отсоединение роли](#отсоединение-роли)
    - [Отсоединение всех ролей](#отсоединение-всех-ролей)
    - [Синхронизация ролей](#синхронизация-ролей)
    - [Проверка наличия роли](#проверка-наличия-роли)
    - [Проверка наличия всех ролей](#проверка-наличия-всех-ролей)
    - [Уровни ролей](#уровни-ролей)
    - [Расширения Blade](#расширения-blade)
    - [Посредники](#посредники)

4. [Титры](#титры)
5. [Лицензия](#лицензия)

## Подключение 

Добавьте ссылку на репозиторий в файл `composer.json`

    "repositories": [
        {
            "type": "vcs",
            "url": "git@github.com:dmitry-rogolev/Is.git"
        }
    ]

Подключите пакет с помощью команды: 

    composer require dmitryrogolev/is

### Публикация ресурсов

Вы можете опубликовать все ресурсы разом

    php artisan is:install 

или по отдельности.

    php artisan is:install --config
    php artisan is:install --migrations
    php artisan is:install --seeders

## Перед использованием

### Миграции 

Таблица ролей имеет следующие основные столбцы:

| Столбец     | Назначение                                        |
|-------------|---------------------------------------------------|
| name        | Название роли.                                    |
| slug        | Человеко-понятный идентификатор. Например, admin. |
| description | Описание [опционально].                           |
| level       | Уровень в иерархии ролей.                         |

Создайте таблицу ролей командой 

    php artisan migrate

### Сидеры

Если вы опубликовали сидеры, то вы можете открыть файл `database/seeders/RoleSeeder.php` и изменить создаваемые роли. 

Затем заполнить таблицу ролей командой 

    php artisan db:seed RoleSeeder

### Добавление функционала ролей модели

В примере ниже мы будем добавлять функционал ролей модели пользователя. Вы же можете добавить данный функционал любой другой модели или нескольким моделям. 

Добавим трейт `dmitryrogolev\Is\Traits\HasRoles` и реализуем интерфейс `dmitryrogolev\Is\Contracts\Roleable` в модели.

    <?php

    namespace App\Models;

    use dmitryrogolev\Is\Contracts\Roleable;
    use dmitryrogolev\Is\Traits\HasRoles;
    use Illuminate\Database\Eloquent\Factories\HasFactory;
    use Illuminate\Foundation\Auth\User as Model;

    class User extends Model implements Roleable
    {
        use HasFactory;
        use HasRoles;

Затем создадим модель `App\Models\Role` и унаследуем ее от модели `dmitryrogolev\Is\Models\Role`.

    <?php

    namespace App\Models;

    use dmitryrogolev\Is\Models\Role as Model;

    class Role extends Model
    {

    }

Наконец, добавим метод, возвращающий [полиморфное отношение](https://clck.ru/36JLPn) `многие-ко-многим` роли с нашей моделью.

    <?php

    namespace App\Models;

    use dmitryrogolev\Is\Models\Role as Model;
    use Illuminate\Database\Eloquent\Relations\MorphToMany;
    use App\Models\User;

    class Role extends Model
    {
        public function users(): MorphToMany
        {
            return $this->roleables(User::class);
        }
    }

### Иерархия ролей

Иерархия ролей призвана упростить логику работы с ролями. Вместо того, чтобы присоединять все необходимые модели роли, достаточно присоединить только одну роль с самым большим уровнем. 

Разберем пример. При регистрации пользователю присоединяются три роли: пользователь, клиент, продавец. Без иерархии ролей потребовалось бы присоединить все три роли.

    $user->attachRole(['user', 'customer', 'seller']);

Но в иерархии ролей мы можем присвоить каждой роли соответствующий уровень, который будет обозначать уровень доступа в приложении.

| Роль     | Уровень |
|----------|:-------:|
| user     |    1    |
| customer |    2    |
| seller   |    3    |

Теперь будет достаточно присоединить пользователю роль с самым большим уровнем.

    $user->attachRole('seller');

После этого пользователь будет иметь все три роли, несмотря на то, что фактически они не были присоединены. 

    if ($user->hasAllRoles(['user', 'customer', 'seller'])) {
        // Пользователь имеет все перечисленные роли.
    }

По умолчанию иерархия ролей включена, но вы можете ее отключить в конфигурации.

    // config/is.php
    config(['is.uses.levels' => false]);

    // .env
    IS_USES_LEVELS=false

## Использование

### Прикрепление роли

Для присоединения одной роли или множества ролей, можно воспользоваться методом `attachRole`, который принимает идентификатор, slug или модель роли, а также их множество. Если роль фактически была присоединена, метод вернет `true`.

    $user->attachRole($id); // bool
    $user->attachRole('admin'); // bool
    $user->attachRole($role); // bool
    $user->attachRole([$id, 'admin', $role]); // bool

### Отсоединение роли

Для отсоединения одной роли или множества ролей, можно воспользоваться методом `detachRole`, который принимает идентификатор, slug или модель роли, а также их множество. Если роль фактически была отсоединена, метод вернет `true`.

    $user->detachRole($id); // bool
    $user->detachRole('admin'); // bool
    $user->detachRole($role); // bool
    $user->detachRole([$id, 'admin', $role]); // bool

### Отсоединение всех ролей

Для отсоединения всех ролей, можно воспользоваться методом `detachAllRoles`. Также можно воспользоваться методом `detachRole` с пустым аргументом. Если роли были фактически отсоединены, метод вернет `true`.

    $user->detachAllRoles(); // bool 
    $user->detachRole(); // bool

### Синхронизация ролей

Для синхронизации ролей можно воспользоваться методом `syncRoles`, который принимает идентификатор, slug или модель роли, а также их множество.

    $user->syncRoles($id); // void
    $user->syncRoles('admin'); // void
    $user->syncRoles($role); // void
    $user->syncRoles([$id, 'admin', $role]); // void

### Проверка наличия роли

Для проверки наличия роли у модели, можно воспользоваться методами `hasRole`, `hasOneRole` или `is`, которые принимают идентификатор, slug или модель роли, а также их множество. Если модель имеет переданную роль, метод вернет `true`. Если иерархия ролей включена, метод вернет `true` для всех ролей (даже для тех, которые фактически не присоединены), которые имеют равный или меньший уровень относительно роли модели с самым большим уровнем.

    if ($user->is('admin')) {
        // Передаем slug роли.
    }

    if ($user->hasRole($id)) {
        // Передаем идентификатор роли.
    }

    if ($user->hasOneRole($role)) {
        // Передаем модель роли.
    }

Если передать множество ролей, метод вернет `true` для первой имеющейся у модели роли. 

    if ($user->is([$id, 'admin', $role])) {
        // У пользователя есть, по крайней мере, одна из переданных ролей.
    }

    if ($user->hasRole([$id, 'admin', $role])) {
        // У пользователя есть, по крайней мере, одна из переданных ролей.
    }

    if ($user->hasOneRole([$id, 'admin', $role])) {
        // У пользователя есть, по крайней мере, одна из переданных ролей.
    }

Для проверки наличия у модели одной роли по slug'у доступен магический метод.

    if ($user->isAdmin()) {
        // У пользователя есть роль со slug'ом "admin"
    }

    if ($user->isModerator()) {
        // У пользователя есть роль со slug'ом "moderator"
    }

### Проверка наличия всех ролей

Для проверки наличия всех переданных ролей у модели, можно воспользоваться методом `hasAllRoles` или методами `hasRole` или `is`, передав им вторым параметром `true`. Они принимают идентификатор, slug или модель роли, а также их множество. Метод возвращает `true` только тогда, когда модель имеет все переданные роли. Если иерархия ролей включена, метод вернет `true` для всех ролей (даже для тех, которые фактически не присоединены), которые имеют равный или меньший уровень относительно роли модели с самым большим уровнем.

    if ($user->is([$id, 'admin', $role], true)) {
        // У пользователя есть все переданные роли.
    }

    if ($user->hasRole([$id, 'admin', $role], true)) {
        // У пользователя есть все переданные роли.
    }

    if ($user->hasAllRoles([$id, 'admin', $role])) {
        // У пользователя есть все переданные роли.
    }

### Уровни ролей

Уровни ролей создают [иерархию ролей](#иерархия-ролей). 

Для получения роли с самым большим уровнем, можно воспользоваться методом `role`. 

    $user->role(); // Illuminate\Database\Eloquent\Model

Для получения самого большого уровня из всех присоединенных ролей, можно воспользоваться методом `level`.

    $user->level(); // int

### Расширения Blade 

По умолчанию в Blade зарегистрированы помощники проверки наличия роли и уровня доступа у пользователя. 

Проверка наличия роли.

    @is('admin') // @if(Auth::check() && Auth::user()->hasRole('admin'))
        // у пользователя есть роль admin
    @endis

    @role('admin') // @if(Auth::check() && Auth::user()->hasRole('admin'))
        // у пользователя есть роль admin
    @endrole

Проверка наличия доступа.

    @level(2) // @if(Auth::check() && Auth::user()->level() >= 2)
        // у пользователя уровень 2 или выше
    @endlevel

Вы можете отключить регистрацию этих директив в конфиге. 

    // config/is.php 
    config(['is.uses.blade' => false]);

    // .env
    IS_USES_BLADE=false

### Посредники 

По умолчанию зарегистрированы посредники `is` и `role`, проверяющие наличие роли и посредник `level`, проверяющий наличие доступа у пользователя к маршруту. 

Проверка наличия роли у пользователя. 

    Route::get('/', function () {
        //
    })->middleware('is:admin');

    Route::get('/', function () {
        //
    })->middleware('role:admin');

Проверка наличия у пользователя доступа к маршруту.

    Route::get('/', function () {
        // Пользователь имеет уровень доступа 2 или больший.
    })->middleware('level:2'); // level >= 2

Вы можете отключить регистрацию этих посредников в конфиге. 

    // config/is.php 
    config(['is.uses.middlewares' => false]);

    // .env
    IS_USES_MIDDLEWARES=false

## Титры

Данный пакет вдохновлен и разработан на основе [jeremykenedy/laravel-roles](https://github.com/jeremykenedy/laravel-roles).

## Лицензия 

Этот пакет является бесплатным программным обеспечением, распространяемым на условиях [лицензии MIT](./LICENSE).
